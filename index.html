<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注专转 住驻专转  - Teddy Inventory</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@300;400;500;700&display=swap" />

    <style>
        :root { --primary-color: #2563eb; --primary-soft: #e0edff; --accent-color: #22c55e; --danger-color: #ef4444; --bg-color: #f3f4f6; --card-bg: #ffffff; --border-color: #e5e7eb; --text-color: #111827; --muted-text: #6b7280; --radius-lg: 16px; --radius-md: 10px; --field-height: 44px; }
        * { box-sizing: border-box; }
        body { font-family: "Noto Sans Hebrew", system-ui, -apple-system, sans-serif; background: radial-gradient(circle at top, #e0f2fe 0, #f3f4f6 42%, #f9fafb 100%); color: var(--text-color); margin: 0; padding: 16px; }
        .container { max-width: 960px; margin: 0 auto; background: var(--card-bg); padding: 24px 20px 20px; border-radius: var(--radius-lg); box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08), 0 0 0 1px rgba(148, 163, 184, 0.12); }
        h1 { text-align: center; margin-bottom: 4px; font-size: 1.7rem; font-weight: 700; }
        .subtitle { text-align: center; font-size: 0.9rem; color: var(--muted-text); margin-bottom: 20px; }
        
        .clinic-selector {
            background: #fffbeb;
            border: 2px solid #fcd34d;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .clinic-selector select { font-weight: bold; color: #78350f; border-color: #fcd34d; }

        #scanner-container { display: none; position: fixed; inset: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.85); z-index: 999; flex-direction: column; align-items: center; justify-content: center; padding: 16px; }
        #reader { width: 100%; max-width: 480px; background: #000; border-radius: 14px; overflow: hidden; }
        .close-scanner { margin-top: 18px; padding: 10px 28px; background: var(--danger-color); color: white; border: none; font-radius: 999px; cursor: pointer; font-weight: 600; border-radius: 20px;}
        .input-group { display: flex; flex-wrap: wrap; gap: 14px; align-items: flex-end; margin-bottom: 20px; background: #f9fafb; padding: 16px; border-radius: 14px; border: 1px solid var(--border-color); }
        .form-field { flex: 1; min-width: 170px; display: flex; flex-direction: column; gap: 6px; }
        .form-field.wide { flex: 2; }
        .barcode-wrapper { display: flex; gap: 8px; align-items: stretch; }
        label { font-size: 0.85rem; font-weight: 600; color: var(--muted-text); }
        input, select { height: var(--field-height); padding: 0 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; background-color: #ffffff; }
        input:focus, select:focus { outline: none; border-color: var(--primary-color); background-color: #f9fafb; }
        button { padding: 10px 16px; border: none; border-radius: 999px; cursor: pointer; font-weight: 600; font-size: 0.9rem; white-space: nowrap; }
        .btn-scan { height: var(--field-height); background: #111827; color: #ffffff; display: flex; align-items: center; gap: 6px; border-radius: var(--radius-md); }
        .btn-add { background: linear-gradient(135deg, var(--accent-color), #16a34a); color: white; margin-top: 10px; align-self: flex-end; min-width: 190px; }
        .actions { display: flex; justify-content: space-between; align-items: center; margin-top: 14px; flex-wrap: wrap; gap: 10px; }
        .summary-pill { background: var(--primary-soft); color: var(--primary-color); padding: 7px 16px; border-radius: 999px; font-size: 0.85rem; font-weight: 600; }
        .btn-export { background: var(--primary-color); color: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 18px; font-size: 0.95rem; border-radius: 14px; overflow: hidden; }
        th, td { text-align: right; padding: 11px 10px; border-bottom: 1px solid #e5e7eb; }
        th { background: #f3f4f6; color: var(--muted-text); font-weight: 600; }
        .delete-row { color: var(--danger-color); background: transparent; padding: 0; text-decoration: underline; cursor: pointer; }
        
        .found-animation { animation: flashGreen 1s ease; }
        @keyframes flashGreen { 0% { background-color: #dcfce7; } 100% { background-color: #ffffff; } }

        @media (max-width: 700px) { .input-group { flex-direction: column; align-items: stretch; } .btn-add { width: 100%; } }
    </style>
</head>
<body>

<div id="scanner-container">
    <div id="reader"></div>
    <button class="close-scanner" onclick="stopScanner()">住专 爪</button>
</div>

<div class="container">
    <h1> 住驻专转  - Teddy Inventory</h1>
    <div class="subtitle">注专转    专砖转</div>

    <div class="clinic-selector">
        <label for="currentClinic"> 拽 住驻专 :</label>
        <select id="currentClinic">
            <option value="专驻 专砖转">专驻 专砖转</option>
            <option value="住祝 爪驻">住祝 爪驻</option>
            <option value="住祝 专">住祝 专</option>
            <option value="住 专砖">住 专砖</option>
            <option value="转">转</option>
        </select>
    </div>

    <div class="input-group">
        <div class="form-field wide">
            <label>专拽</label>
            <div class="barcode-wrapper">
                <input type="text" id="barcode" placeholder="住专拽  拽 专拽..." autofocus onblur="checkForExistingProduct()">
                <button class="btn-scan" onclick="startScanner()"><span></span> 住专拽</button>
            </div>
        </div>
        <div class="form-field wide">
            <label>砖 爪专</label>
            <input type="text" id="productName" placeholder="砖 驻专">
        </div>
        <div class="form-field">
            <label>拽专 专砖转</label>
            <select id="primaryCategory">
                <option value="">专 拽专</option>
                <option value="砖驻">砖驻</option>
                <option value="爪 专驻">爪 专驻</option>
                <option value="转专驻转">转专驻转</option>
            </select>
        </div>
        <div class="form-field">
            <label>转转志拽专</label>
            <select id="subCategory" disabled>
                <option value="">专 转转志拽专</option>
            </select>
        </div>
        <div class="form-field">
            <label>转</label>
            <input type="number" id="quantity" placeholder="0" min="1" value="1">
        </div>
        <div class="form-field">
            <label>转拽祝</label>
            <input type="date" id="expiry">
        </div>
        <button class="btn-add" id="addBtn">住祝 砖专 </button>
    </div>

    <div class="actions">
        <span id="totalItems" class="summary-pill">砖专转: 0</span>
        <div>
            <button class="btn-export" onclick="exportToCSV()"> 专转 拽住</button>
        </div>
    </div>

    <table id="inventoryTable">
        <thead>
            <tr>
                <th>专驻</th>
                <th>专拽</th>
                <th>砖</th>
                <th>拽专</th>
                <th>转转志拽专</th>
                <th>转</th>
                <th>转拽祝</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script type="module">
    // ------------------------------------------------------------------
    //  Firebase
    // ------------------------------------------------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, Timestamp, where, limit, getDocs } 
           from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBn8bKKDq220_Ogm4mt6aBK6BeP0D6n6u0",
      authDomain: "teddyinventory.firebaseapp.com",
      projectId: "teddyinventory",
      storageBucket: "teddyinventory.firebasestorage.app",
      messagingSenderId: "382867870794",
      appId: "1:382867870794:web:f99c1460f79e3e9ef5c2b3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const inventoryCol = collection(db, "inventory");

    // 砖转 
    window.currentInventoryData = [];
    let html5QrCode;

    // 驻转 拽专转
    const subcategoriesMap = {
        "砖驻": [" 专驻", "转住驻 ", "驻", "砖拽", "转 驻", "专 (砖驻 ')", "专"],
        "爪 专驻": ["转", "专"],
        "转专驻转": [""]
    };

    // ------------------------------------------------------------------
    // Firebase:  驻注转
    // ------------------------------------------------------------------
    
    //  砖 
    const q = query(inventoryCol, orderBy("timestamp", "desc"));
    onSnapshot(q, (snapshot) => {
        const tableBody = document.querySelector('#inventoryTable tbody');
        tableBody.innerHTML = ''; 
        window.currentInventoryData = []; 
        
        snapshot.forEach((doc) => {
            const item = doc.data();
            item.id = doc.id; 
            window.currentInventoryData.push(item);
            
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td><strong>${item.clinic || '-'}</strong></td>
                <td>${item.barcode || ''}</td>
                <td>${item.name || ''}</td>
                <td>${item.primaryCategory || ''}</td>
                <td>${item.subCategory || ''}</td>
                <td>${item.quantity || ''}</td>
                <td>${item.expiry || ''}</td>
                <td><button class="delete-row" data-id="${doc.id}">拽</button></td>
            `;
        });
        
        // 专 驻转专 拽
        document.querySelectorAll('.delete-row').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const id = e.target.getAttribute('data-id');
                if(confirm('拽 砖专 ?')) {
                    await deleteDoc(doc(db, "inventory", id));
                }
            });
        });

        document.getElementById('totalItems').innerText = '砖专转: ' + snapshot.size;
    });

    // 住驻转 爪专 (专转 -Window)
    window.addItem = async function() {
        const clinic = document.getElementById('currentClinic').value;
        const barcode = document.getElementById('barcode').value.trim();
        const name = document.getElementById('productName').value.trim();
        const primaryCategory = document.getElementById('primaryCategory').value;
        const subCategory = document.getElementById('subCategory').value;
        const quantity = document.getElementById('quantity').value;
        const expiry = document.getElementById('expiry').value;

        if (!barcode && !name) { alert("  驻转 专拽  砖 爪专."); return; }
        if (!primaryCategory) { alert(" 专 拽专 专砖转."); return; }

        const addBtn = document.getElementById('addBtn');
        addBtn.disabled = true;
        addBtn.innerText = "砖专...";

        try {
            await addDoc(inventoryCol, {
                clinic, barcode, name, primaryCategory, subCategory, quantity, expiry,
                timestamp: Timestamp.now()
            });
            resetInputs();
        } catch (e) {
            console.error("Error:", e);
            alert("砖 砖专");
        }
        
        addBtn.disabled = false;
        addBtn.innerText = "住祝 砖专 ";
    }

    // 砖 转 (专转 -Window)
    window.checkForExistingProduct = async function() {
        const barcodeInput = document.getElementById('barcode');
        const barcode = barcodeInput.value.trim();
        if (!barcode) return; 

        const qCheck = query(inventoryCol, where("barcode", "==", barcode), limit(1));
        
        try {
            const querySnapshot = await getDocs(qCheck);
            if (!querySnapshot.empty) {
                const existingData = querySnapshot.docs[0].data();
                
                const nameInput = document.getElementById('productName');
                nameInput.value = existingData.name || '';
                nameInput.classList.add('found-animation');

                const catSelect = document.getElementById('primaryCategory');
                catSelect.value = existingData.primaryCategory || '';
                
                // 注 住拽 砖 转转 拽专
                updateSubCategoryOptions(existingData.primaryCategory);

                const subCatSelect = document.getElementById('subCategory');
                subCatSelect.value = existingData.subCategory || '';

                document.getElementById('quantity').value = '1';
                document.getElementById('quantity').focus();
                
                setTimeout(() => nameInput.classList.remove('found-animation'), 1000);
            }
        } catch (e) {
            console.log("Error checking barcode:", e);
        }
    }

    // 爪 拽住 (专 -Window)
    window.exportToCSV = function() {
        if(!window.currentInventoryData || window.currentInventoryData.length === 0) {
            alert(" 转 爪");
            return;
        }
        let csvContent = "\uFEFF专驻,专拽,砖 爪专,拽专 专砖转,转转 拽专,转,转拽祝\n";
        window.currentInventoryData.forEach(item => {
            const clinicName = (item.clinic || '').replace(/,/g, " ");
            csvContent += `${clinicName},${item.barcode},${item.name},${item.primaryCategory},${item.subCategory},${item.quantity},${item.expiry}\n`;
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "inventory_teddy_multi.csv";
        link.click();
    }

    // ------------------------------------------------------------------
    // 拽 转 (砖拽, 爪)
    // ------------------------------------------------------------------

    //  拽专转
    function updateSubCategoryOptions(primary) {
        const subSelect = document.getElementById('subCategory');
        subSelect.innerHTML = '<option value="">专 转转志拽专</option>';
        
        if (!primary || !subcategoriesMap[primary]) {
            subSelect.disabled = true; return;
        }

        subcategoriesMap[primary].forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.textContent = sub;
            subSelect.appendChild(option);
        });
        subSelect.disabled = false;
        
        if (subcategoriesMap[primary].length === 1) {
            subSelect.value = subcategoriesMap[primary][0];
        }
    }

    function initCategorySelects() {
        const primarySelect = document.getElementById('primaryCategory');
        primarySelect.addEventListener('change', () => {
            updateSubCategoryOptions(primarySelect.value);
        });
    }

    function resetInputs() {
        document.getElementById('barcode').value = '';
        document.getElementById('productName').value = '';
        // 砖专 转 专驻 驻 砖
        document.getElementById('primaryCategory').value = '';
        const subSelect = document.getElementById('subCategory');
        subSelect.innerHTML = '<option value="">专 转转志拽专</option>';
        subSelect.disabled = true;
        document.getElementById('quantity').value = '1';
        document.getElementById('expiry').value = '';
        document.getElementById('barcode').focus();
    }

    //  爪 - 专 -Window
    window.startScanner = function() {
        const scannerContainer = document.getElementById('scanner-container');
        scannerContainer.style.display = 'flex';
        html5QrCode = new Html5Qrcode("reader");
        const config = { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 };
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
        .catch(err => { alert("砖 爪:  砖转专  (HTTPS)"); window.stopScanner(); });
    }

    function onScanSuccess(decodedText) {
        playBeep();
        document.getElementById('barcode').value = decodedText;
        window.stopScanner();
        window.checkForExistingProduct(); 
    }

    window.stopScanner = function() {
        const scannerContainer = document.getElementById('scanner-container');
        if (html5QrCode) {
            html5QrCode.stop().then(() => { scannerContainer.style.display = 'none'; html5QrCode.clear(); })
            .catch(() => { scannerContainer.style.display = 'none'; });
        } else { scannerContainer.style.display = 'none'; }
    }

    function playBeep() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 1200;
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.1);
        setTimeout(() => osc.stop(), 100);
    }

    // 转 注转 祝
    document.addEventListener('DOMContentLoaded', () => {
        initCategorySelects();
        // 专 专注 拽转
        document.getElementById('addBtn').addEventListener('click', window.addItem);
        
        document.getElementById('quantity').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') window.addItem();
        });
        document.getElementById('productName').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') document.getElementById('quantity').focus();
        });
        document.getElementById('barcode').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') window.checkForExistingProduct();
        });
    });

</script>
</body>
</html>
